{% extends "base.html" %}

{% block title %}Mock Exam Generator - Ca' Foscari Ultimate{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1 class="text-white mb-4"><i class="fas fa-file-alt"></i> Mock Exam Generator</h1>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-plus-circle"></i> Create Mock Exam</h5>
            </div>
            <div class="card-body">
                <form id="mockExamForm">
                    <div class="mb-3">
                        <label for="courseSelect" class="form-label">Select Course</label>
                        <select class="form-select" id="courseSelect" required>
                            <option value="">Choose a course...</option>
                            {% for code, course in courses.items() %}
                            <option value="{{ code }}" {% if request.args.get('course') == code %}selected{% endif %}>
                                {{ code }} - {{ course.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label for="emailInput" class="form-label">Email Address (Optional)</label>
                        <input type="email" class="form-control" id="emailInput" placeholder="student@example.com">
                        <div class="form-text">If provided, the mock exam PDF will be sent via email</div>
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-magic"></i> Generate Mock Exam
                        </button>
                    </div>
                </form>

                <!-- Results Area -->
                <div id="resultsArea" class="mt-4" style="display: none;">
                    <hr>
                    <div id="successMessage" class="alert alert-success" style="display: none;"></div>
                    <div id="errorMessage" class="alert alert-danger" style="display: none;"></div>

                    <div id="examDetails" style="display: none;">
                        <h5><i class="fas fa-file-pdf"></i> Exam Generated Successfully</h5>
                        <div class="card">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <p><strong>Course:</strong> <span id="examCourse"></span></p>
                                        <p><strong>Generated:</strong> <span id="examTime"></span></p>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="d-grid gap-2">
                                            <a id="downloadLink" class="btn btn-primary" href="#" target="_blank">
                                                <i class="fas fa-download"></i> Download PDF
                                            </a>
                                        </div>
                                    </div>
                                </div>
                                <div id="emailStatus" style="display: none;" class="mt-3">
                                    <div class="alert alert-info">
                                        <i class="fas fa-envelope"></i> Email sent successfully to <strong id="emailAddress"></strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Instructions -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-info-circle"></i> How It Works</h6>
            </div>
            <div class="card-body">
                <ol class="small">
                    <li>Select a course from the dropdown</li>
                    <li>Optionally enter an email address</li>
                    <li>Click "Generate Mock Exam"</li>
                    <li>System will analyze previous exams</li>
                    <li>Creates a Ca' Foscari format PDF</li>
                    <li>Download or receive via email</li>
                </ol>
            </div>
        </div>

        <!-- Features -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-star"></i> Features</h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled small">
                    <li><i class="fas fa-check text-success"></i> Authentic Ca' Foscari format</li>
                    <li><i class="fas fa-check text-success"></i> Based on previous exams</li>
                    <li><i class="fas fa-check text-success"></i> AI-generated questions</li>
                    <li><i class="fas fa-check text-success"></i> PDF download</li>
                    <li><i class="fas fa-check text-success"></i> Email delivery</li>
                    <li><i class="fas fa-check text-success"></i> Automatic caching</li>
                </ul>
            </div>
        </div>

        <!-- Recent Exams -->
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-history"></i> Recent Exams</h6>
            </div>
            <div class="card-body">
                <div id="recentExams">
                    <p class="text-muted small">Generated exams will appear here</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-4">
                <div class="loading-dots mx-auto mb-3">
                    <div></div><div></div><div></div><div></div>
                </div>
                <h5>Generating Mock Exam...</h5>
                <p class="text-muted mb-0">Analyzing previous exams and creating your personalized test</p>
                <div class="progress mt-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('mockExamForm').addEventListener('submit', function(e) {
    e.preventDefault();
    generateMockExam();
});

function generateMockExam() {
    const courseSelect = document.getElementById('courseSelect');
    const emailInput = document.getElementById('emailInput');

    const courseCode = courseSelect.value;
    const email = emailInput.value.trim();

    if (!courseCode) {
        showError('Please select a course');
        return;
    }

    // Show loading modal
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'));
    loadingModal.show();

    // Hide previous results
    hideResults();

    // Send request
    fetch('/api/generate-mock-exam', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            course_code: courseCode,
            email: email
        })
    })
    .then(response => response.json())
    .then(data => {
        loadingModal.hide();

        if (data.error) {
            showError(data.error);
        } else {
            showSuccess(data);
        }
    })
    .catch(error => {
        loadingModal.hide();
        showError('Request failed: ' + error.message);
    });
}

function showSuccess(data) {
    const resultsArea = document.getElementById('resultsArea');
    const examDetails = document.getElementById('examDetails');

    // Update exam details
    document.getElementById('examCourse').textContent = data.course_name;
    document.getElementById('examTime').textContent = new Date().toLocaleString();
    document.getElementById('downloadLink').href = data.download_url;

    // Show email status if email was sent
    if (data.email_sent) {
        document.getElementById('emailStatus').style.display = 'block';
        document.getElementById('emailAddress').textContent = data.email;
    } else {
        document.getElementById('emailStatus').style.display = 'none';
    }

    // Show results
    resultsArea.style.display = 'block';
    examDetails.style.display = 'block';

    // Add to recent exams
    addToRecentExams(data);

    // Scroll to results
    resultsArea.scrollIntoView({ behavior: 'smooth' });
}

function showError(message) {
    const resultsArea = document.getElementById('resultsArea');
    const errorMessage = document.getElementById('errorMessage');

    errorMessage.textContent = message;
    errorMessage.style.display = 'block';
    resultsArea.style.display = 'block';

    resultsArea.scrollIntoView({ behavior: 'smooth' });
}

function hideResults() {
    document.getElementById('resultsArea').style.display = 'none';
    document.getElementById('successMessage').style.display = 'none';
    document.getElementById('errorMessage').style.display = 'none';
    document.getElementById('examDetails').style.display = 'none';
}

function addToRecentExams(data) {
    const recentExams = document.getElementById('recentExams');

    // Create new exam entry
    const examItem = document.createElement('div');
    examItem.className = 'mb-2 p-2 border rounded';
    examItem.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <small class="fw-bold">${data.course_name.split(' - ')[0]}</small><br>
                <small class="text-muted">${new Date().toLocaleString()}</small>
            </div>
            <a href="${data.download_url}" class="btn btn-outline-primary btn-sm" target="_blank">
                <i class="fas fa-download"></i>
            </a>
        </div>
    `;

    // Add to top of list
    if (recentExams.firstChild && recentExams.firstChild.textContent.includes('Generated exams')) {
        recentExams.innerHTML = '';
    }

    recentExams.insertBefore(examItem, recentExams.firstChild);

    // Keep only last 5 items
    while (recentExams.children.length > 5) {
        recentExams.removeChild(recentExams.lastChild);
    }
}
</script>
{% endblock %}